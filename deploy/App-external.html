<!DOCTYPE html>
<html>
<head>
    <title>feature-component-summary</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/0.2.7/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ComponentRenderer",function(){var self;return{config:{estimatevalues:[],columns:[]},constructor:function(config){return self=this,this.initConfig(config),this},offsetColumnIndex:function(col,colIdx){var cols=_.filter(col.getColumns(),function(c){return c.locked===!0});return cols.length+colIdx},renderPreliminaryEstimate:function(value){var _localValue=value?value._refObjectName+" ("+self.pointValue(value)+")":"";return _localValue},renderRefinedEstimate:function(value){var _localValue=value?value._refObjectName+" ("+self.pointValue(value)+")":"";return"Testing 1 2 3"},renderState:function(value){return value?value._refObjectName:""},renderComponentValuePointsEstimate:function(value,metaData,record,rowIdx,colIdx,store,view){var idx=self.offsetColumnIndex(self,colIdx),name=self.getColumns()[idx].project,reqs=_.filter(value,function(r){return r.get("Project").Name===name}),val=reqs?_.reduce(reqs,function(memo,r){return memo+r.get("LeafStoryPlanEstimateTotal")},0):0;return 0!==val?val:""},renderTotalComponentValuePreliminaryEstimate:function(value,metaData,record,rowIdx,colIdx,store,view){var val=value?self.sumRequirementEstimates(value):0;return 0!==val?val:""},renderTotalComponentValueRefinedEstimate:function(value,metaData,record,rowIdx,colIdx,store,view){var val=value?self.sumRequirementRefinedEstimates(value):0;return 0!==val?val:""},renderCountFeatures:function(value,metaData,record,rowIdx,colIdx,store,view){return value.length},renderWorkRemaining:function(value,metaData,record,rowIdx,colIdx,store,view){var idx=self.offsetColumnIndex(self,colIdx),name=self.getColumns()[idx].project,reqs=_.filter(value,function(r){return r.get("Project").Name===name}),val=reqs?_.reduce(reqs,function(memo,r){var accepted=r.get("AcceptedLeafStoryPlanEstimateTotal");return accepted=_.isNull(accepted)?0:accepted,memo+r.get("LeafStoryPlanEstimateTotal")-accepted},0):0;return 0!==val?val:""},renderTotalPrePCD:function(value,metaData,record,rowIdx,colIdx,store,view){var val=value?_.reduce(value,function(memo,r){var pcd=r.get("c_PrePCDWorkMM");return memo+(pcd?pcd:0)},0):0;return 0!==val?val:""},renderComponentValuePreliminaryEstimate:function(value,metaData,record,rowIdx,colIdx,store,view){var idx=self.offsetColumnIndex(self,colIdx),name=self.getColumns()[idx].project,reqs=_.filter(value,function(r){return r.get("Project").Name===name}),val=reqs?self.sumRequirementEstimates(reqs):0;return 0!==val?val:""},pointValue:function(est){var p=_.find(self.getEstimatevalues(),function(ev){return ev.get("Name")===est._refObjectName});return p?p.get("Value"):0},pointValueForEstimate:function(pi){return null!==pi.get("PreliminaryEstimate")?self.pointValue(pi.get("PreliminaryEstimate")):0},sumRequirementEstimates:function(reqs){return _.reduce(reqs,function(memo,r){return memo+self.pointValueForEstimate(r)},0)},sumRequirementRefinedEstimates:function(reqs){var rEsts=reqs.map(function(a){return a.get("RefinedEstimate")});return rEsts.reduce(function(a,b){return a+b},0)}}}),Ext.define("GridExporter",{dateFormat:"Y-m-d",exportGrid:function(grid){if(!Ext.isIE){var data=this._getCSV(grid);return"<a href='data:text/csv;charset=utf8,"+encodeURIComponent(data)+"' download='export.csv'>Click to download file</a>"}this._ieToExcel(grid)},_escapeForCSV:function(string){return string=""+string,string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData,record,col,index){var text;return text=col&&"PrePCD"===col.renderType?app.renderer.renderTotalPrePCD(fieldData,0,record,0,index):col&&"WorkRemaining"===col.renderType?app.renderer.renderWorkRemaining(fieldData,0,record,0,index-this.fixedCols):col&&"ComponentEstimate"===col.renderType?app.renderer.renderComponentValuePreliminaryEstimate(fieldData,0,record,0,index-this.fixedCols):col&&"ComponentStoryEstimate"===col.renderType?app.renderer.renderComponentValuePointsEstimate(fieldData,0,record,0,index-this.fixedCols):col&&"renderTotalComponentValuePreliminaryEstimate"===col.renderType?app.renderer.renderTotalComponentValuePreliminaryEstimate(fieldData,0,record,0,index):col&&"renderTotalComponentValueRefinedEstimate"===col.renderType?app.renderer.renderTotalComponentValueRefinedEstimate(fieldData,0,record,0,index):col&&"renderCountFeatures"===col.renderType?app.renderer.renderCountFeatures(fieldData,0,record,0,index):null===fieldData||void 0===fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData},_getFieldTextAndEscape:function(fieldData,record,col,index){var string=this._getFieldText(fieldData,record,col,index);return this._escapeForCSV(string)},fixedColumnCount:function(columns){var cols=_.filter(columns,function(c){return void 0!==c&&null!==c&&c.locked===!0});return cols.length},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="";this.fixedCols=this.fixedColumnCount(cols);var createHeaderIndex=function(cols,fixedColsCount){console.log("fixedColsCount",fixedColsCount);var headerIndex=_.object(_.pluck(cols,"text"),_.range(cols.length));console.log("headerIndex",headerIndex);var keys=_.keys(headerIndex);console.log("keys",keys);var fixed=keys.slice(0,fixedColsCount);console.log("fixed",fixed);var variable=keys.slice(fixedColsCount).sort();console.log("variable",variable);var sortedKeys=_.union(fixed,variable);console.log("sortedKeys",sortedKeys);var values=_.map(sortedKeys,function(key){return headerIndex[key]});console.log("values",values);var index=_.object(sortedKeys,values);return console.log("index",index),index},sortCols=function(cols,fixedColsCount){var fixed=cols.slice(0,fixedColsCount),variable=cols.slice(fixedColsCount);variable=_.sortBy(variable,"text");var sortedCols=_.union(fixed,variable);return sortedCols},headerIndex=createHeaderIndex(cols,this.fixedCols),sortedCols=sortCols(cols,this.fixedCols),that=this;return Ext.Array.each(sortedCols,function(col,index){if(col.hidden!==!0){var colLabel=(0===index?"Item ":"")+col.text;colLabel=colLabel.replace(/<br\/?>/,""),data+=that._getFieldTextAndEscape(colLabel)+","}}),data+="\n",_.each(store.data.items,function(record){Ext.Array.each(sortedCols,function(col){var index=headerIndex[col.text];if(col.hidden!==!0){var fieldName=col.dataIndex,text=record.get(fieldName);data+=that._getFieldTextAndEscape(text,record,col,index)+","}}),data+="\n"}),data},_ieGetGridData:function(grid,sheet){var that=this,resourceItems=grid.store.data.items,cols=grid.columns;Ext.Array.each(cols,function(col,colIndex){col.hidden!==!0&&(sheet.cells(1,colIndex+1).value=col.text)});var rowIndex=2;grid.store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,colIndex){if(col.hidden!==!0){var fieldName=col.dataIndex,text=entry[fieldName],value=that._getFieldText(text);sheet.cells(rowIndex,colIndex+1).value=value}}),rowIndex++})},_ieToExcel:function(grid){if(window.ActiveXObject){var xlApp,xlBook;try{xlApp=new ActiveXObject("Excel.Application"),xlBook=xlApp.Workbooks.Add()}catch(e){return Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."'),void 0}var temp1=xlBook.worksheets("Sheet1").activate,XlSheet=xlBook.activeSheet;xlApp.visible=!0,this._ieGetGridData(grid,XlSheet);var temp2=XlSheet.columns.autofit}}});
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",componentNames:[],items:[{itemId:"exportContainer",layout:"column",items:[{itemId:"exportButton",margin:10},{itemId:"exportLink",margin:"12 0 0 10"}]},{itemId:"container",layout:"column"}],config:{defaultSettings:{parentId:"",showStoryColumns:!0}},getSettingsFields:function(){return[{name:"parentId",xtype:"rallytextfield",label:"Parent Portfolio Item ID"},{name:"filterWithdrawn",xtype:"rallycheckboxfield",label:"Exclude Withdrawn Epics"},{name:"showStoryColumns",xtype:"rallycheckboxfield",label:"Show Story Columns"}]},launch:function(){app=this,app.exporter=Ext.create("GridExporter");var configs=[{model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]},{model:"TypeDefinition",fetch:!0,filters:[{property:"Ordinal",operator:"=",value:1}]},{model:"TypeDefinition",fetch:!0,filters:[{property:"Ordinal",operator:"=",value:0}]},{model:"Project",fetch:["ObjectID"],filters:[{property:"State",operator:"=",value:"Open"}],context:{project:null}}];async.map(configs,this.wsapiQuery,function(err,results){app.featureType=results[1][0].get("TypePath"),app.releaseType=results[2][0].get("TypePath"),app.openProjectIDs=_.map(results[3],function(project){return project.get("ObjectID")}),app.renderer=Ext.create("ComponentRenderer",{estimatevalues:results[0]}),app.renderer.setColumns(app.addColumns()),app.exportButton=app.addExportButton(),app.down("#exportButton").add(app.exportButton),app.createGrid()})},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),console.log("release selected");var timeboxScope=app.getContext().getTimeboxScope();if(console.log("timeboxscope",timeboxScope),null!==timeboxScope){var record=timeboxScope.getRecord(),name=record.get("Name");app.releaseName=name,console.log("name",name)}},addColumns:function(){return[{locked:!0,text:"ID",dataIndex:"FormattedID",width:45,sortable:!1},{locked:!0,text:"Name",dataIndex:"Name",width:200,sortable:!1},{locked:!0,text:"State",dataIndex:"State",renderer:app.renderer.renderState,sortable:!1},{locked:!0,text:"Feature PEst",dataIndex:"PreliminaryEstimate",width:85,renderer:app.renderer.renderPreliminaryEstimate,sortable:!1},{locked:!0,text:"S Team<br/>Story Pts",dataIndex:"LeafStoryPlanEstimateTotal",width:85,sortable:!1},{locked:!0,text:"S Team<br/>Story Cnt",dataIndex:"LeafStoryCount",width:85,sortable:!1}]},addExportButton:function(){var button=Ext.create("Rally.ui.Button",{text:"Export",handler:function(){var link=app.down("#exportLink");console.log("link",link),link.update(app.exporter.exportGrid(app.grid))}});return button},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,context:{project:null},listeners:{scope:this,load:function(store,data){callback(null,data)}}})},featuresLoaded:function(items){var features=items.data.items,loadChildren=function(child,callback){child.getCollection("Children").load({fetch:!0,callback:function(records,operation,success){records=_.filter(records,function(record){return _.contains(app.openProjectIDs,record.get("Project").ObjectID)}),callback(null,records)}})};async.map(features,loadChildren,function(err,results){app.addComponentTotalColumn(),_.each(features,function(f,i){var requirements=results[i];f.set("Requirements",requirements),app.addComponentNames(requirements)}),app.grid.reconfigure(app.store,app.renderer.getColumns())})},addComponentTotalColumn:function(){0===app.componentNames.length&&(app.renderer.getColumns().push(Ext.create("Ext.grid.column.Column",{renderType:"renderTotalComponentValuePreliminaryEstimate",text:name+"S Team PEst",dataIndex:"Requirements",renderer:app.renderer.renderTotalComponentValuePreliminaryEstimate,cls:"component-color",width:85,sortable:!1,locked:!0,align:"right"})),app.renderer.getColumns().push(Ext.create("Ext.grid.column.Column",{renderType:"renderTotalComponentValueRefinedEstimate",text:name+"Refined Est",dataIndex:"Requirements",renderer:app.renderer.renderTotalComponentValueRefinedEstimate,cls:"component-color",width:85,sortable:!1,locked:!0,align:"right"})),app.renderer.getColumns().push(Ext.create("Ext.grid.column.Column",{renderType:"renderCountFeatures",text:name+"Feature Count",dataIndex:"Requirements",renderer:app.renderer.renderCountFeatures,cls:"component-color",width:85,sortable:!1,locked:!0,align:"right"})))},addComponentNames:function(requirements){var projectNames=_.uniq(_.map(requirements,function(r){return r.get("Project").Name}));_.each(projectNames,function(name){-1==_.indexOf(app.componentNames,name)&&(app.componentNames.push(name),app.showStoryColumns===!1&&app.renderer.getColumns().push(Ext.create("Ext.grid.column.Column",{project:name,renderType:"ComponentEstimate",text:name+" <br>Team PEst",dataIndex:"Requirements",renderer:app.renderer.renderComponentValuePreliminaryEstimate,cls:"component-color",width:85,sortable:!1,align:"right"})),app.showStoryColumns===!0&&app.renderer.getColumns().push(Ext.create("Ext.grid.column.Column",{project:name,renderType:"WorkRemaining",text:name+" <br>Work Remaining",dataIndex:"Requirements",renderer:app.renderer.renderWorkRemaining,cls:"component-color",width:85,sortable:!1,align:"right"})))})},createGrid:function(){var parentIds=app.getSetting("parentId"),filterWithdrawn=app.getSetting("filterWithdrawn");app.showStoryColumns=app.getSetting("showStoryColumns");var filter=[];if(_.each(parentIds.split(","),function(parentId,i){if(""!==parentId){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Parent.FormattedID",operator:"=",value:parentId.replace(/^\s+|\s+$/g,"")});filter=0===i?f:filter.or(f)}}),filterWithdrawn){console.log("Apply Withdrawn filter");var f=Ext.create("Rally.data.wsapi.Filter",{property:"c_WithdrawnONHOLD",operator:"!=",value:!0});filter=0===filter.length?f:filter.and(f)}console.log("filter:",""+filter),(_.isNull(app.store)||_.isUndefined(app.store))&&(app.store=Ext.create("Rally.data.WsapiDataStore",{model:app.featureType,listeners:{load:app.featuresLoaded},sorters:[{property:"Rank",direction:"DSC"}],fetch:!0,autoLoad:!0,filters:filter})),console.log("filter:",""+filter),app.grid=Ext.create("Ext.grid.Panel",{title:"Features",listeners:{afterrender:function(){}},store:app.store,columns:app.renderer.getColumns()}),app.add(app.grid)}});

            Rally.launchApp('CustomApp', {
                name:"feature-component-summary",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .component-color{background-color:Gainsboro}
    </style>
</head>
<body>
</body>
</html>
