<!DOCTYPE html>
<html>
<head>
    <title>feature-component-summary</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/0.2.7/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ComponentRenderer",function(){var self;return{config:{estimatevalues:[],columns:[]},constructor:function(config){return self=this,this.initConfig(config),this},renderPreliminaryEstimate:function(value){return value?value._refObjectName+" ("+self.pointValue(value)+")":""},renderState:function(value){return value?value._refObjectName:""},renderComponentValue:function(value,metaData,record,rowIdx,colIdx,store,view){var name=self.getColumns()[colIdx].text,reqs=_.filter(value,function(r){return r.get("Project").Name===name}),val=reqs?self.sumRequirementEstimates(reqs):0;return 0!==val?val:""},pointValue:function(est){var p=_.find(self.getEstimatevalues(),function(ev){return ev.get("Name")===est._refObjectName});return p?p.get("Value"):0},pointValueForEstimate:function(pi){return null!==pi.get("PreliminaryEstimate")?self.pointValue(pi.get("PreliminaryEstimate")):0},sumRequirementEstimates:function(reqs){return _.reduce(reqs,function(memo,r){return memo+app.renderer.pointValueForEstimate(r)},0)}}}),Ext.define("GridExporter",{dateFormat:"Y-m-d",exportGrid:function(grid){if(Ext.isIE)this._ieToExcel(grid);else{var data=this._getCSV(grid);window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)}},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData){var text;return text=null==fieldData||void 0==fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="";console.log("store",store);var that=this;return Ext.Array.each(cols,function(col,index){1!=col.hidden&&(data+=that._getFieldTextAndEscape(col.text)+",")}),data+="\n",_.each(store.data.items,function(record){console.log("rec",record),Ext.Array.each(cols,function(col,index){if(console.log("col",col,index),1!=col.hidden){var fieldName=col.dataIndex,text=""+record.get(fieldName);console.log("text",text),data+=that._getFieldTextAndEscape(text)+","}}),data+="\n"}),data},_ieGetGridData:function(grid,sheet){var that=this,resourceItems=grid.store.data.items,cols=grid.columns;Ext.Array.each(cols,function(col,colIndex){1!=col.hidden&&(console.log("header: ",col.text),sheet.cells(1,colIndex+1).value=col.text)});var rowIndex=2;grid.store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,colIndex){if(1!=col.hidden){var fieldName=col.dataIndex,text=entry[fieldName],value=that._getFieldText(text);sheet.cells(rowIndex,colIndex+1).value=value}}),rowIndex++})},_ieToExcel:function(grid){if(window.ActiveXObject){var xlApp,xlBook;try{xlApp=new ActiveXObject("Excel.Application"),xlBook=xlApp.Workbooks.Add()}catch(e){return Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."'),void 0}xlBook.worksheets("Sheet1").activate;var XlSheet=xlBook.activeSheet;xlApp.visible=!0,this._ieGetGridData(grid,XlSheet),XlSheet.columns.autofit}}});
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this,app.exporter=Ext.create("GridExporter");var configs=[{model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]},{model:"TypeDefinition",fetch:!0,filters:[{property:"Ordinal",operator:"=",value:1}]}];async.map(configs,this.wsapiQuery,function(err,results){console.log(results[1]);var type=results[1][0].get("TypePath");app.renderer=Ext.create("ComponentRenderer",{estimatevalues:results[0]}),app.renderer.setColumns(app.addColumns()),app.addExportButton(),app.addFeatureGrid(type)})},componentNames:[],addColumns:function(){return[{text:"ID",dataIndex:"FormattedID",width:45},{text:"Name",dataIndex:"Name",width:200},{text:"State",dataIndex:"State",renderer:app.renderer.renderState},{text:"P. Estimate",dataIndex:"PreliminaryEstimate",width:75,renderer:app.renderer.renderPreliminaryEstimate},{text:"Story Count",dataIndex:"LeafStoryCount",width:75},{text:"Story Points",dataIndex:"LeafStoryPlanEstimateTotal",width:75}]},addExportButton:function(){var button=Ext.create("Rally.ui.Button",{text:"Export",handler:function(){app.exporter.exportGrid(app.grid)}});this.add(button)},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},featuresLoaded:function(items){var features=items.data.items,loadChildren=function(child,callback){child.getCollection("Children").load({fetch:!0,callback:function(records,operation,success){callback(null,records)}})};async.map(features,loadChildren,function(err,results){_.each(features,function(f,i){var requirements=results[i];f.set("Requirements",requirements),app.addComponentNames(requirements)}),app.grid.reconfigure(app.store,app.renderer.getColumns())})},addComponentNames:function(requirements){var projectNames=_.uniq(_.map(requirements,function(r){return r.get("Project").Name}));_.each(projectNames,function(name){-1==_.indexOf(app.componentNames,name)&&(app.componentNames.push(name),app.renderer.getColumns().push(Ext.create("Ext.grid.column.Column",{text:name,dataIndex:"Requirements",renderer:app.renderer.renderComponentValue,cls:"component-color",width:75})))})},addFeatureGrid:function(type){app.store=Ext.create("Rally.data.WsapiDataStore",{model:type,listeners:{load:app.featuresLoaded},fetch:!0,autoLoad:!0}),app.grid=Ext.create("Ext.grid.Panel",{title:"Features",listeners:{afterrender:function(){console.log("afterRender",app.renderer.getColumns()),app.grid.reconfigure(app.store,app.renderer.getColumns())}},store:app.store,columns:app.renderer.getColumns(),height:600,width:1200}),app.add(app.grid)}});

            Rally.launchApp('CustomApp', {
                name:"feature-component-summary",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */

}

.component-color {
	background-color: Gainsboro; 
}

    </style>
</head>
<body></body>
</html>
