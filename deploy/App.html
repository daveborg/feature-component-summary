<!DOCTYPE html>
<html>
<head>
    <title>feature-component-summary</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/0.2.7/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this;var configs=[{model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]}];async.map(configs,this.wsapiQuery,function(err,results){app.estimateValues=results[0],app.addFeatureGrid()})},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},componentNames:[],columns:[{text:"ID",dataIndex:"FormattedID",width:45},{text:"Name",dataIndex:"Name",width:200},{text:"State",dataIndex:"State",renderer:function(value){return value?value._refObjectName:""}},{text:"P. Estimate",dataIndex:"PreliminaryEstimate",width:75,renderer:function(value){return console.log(value),value?value._refObjectName+" ("+app.pointValue(value)+")":""}},{text:"Story Count",dataIndex:"LeafStoryCount",width:75},{text:"Story Points",dataIndex:"LeafStoryPlanEstimateTotal",width:75}],pointValue:function(est){var p=_.find(app.estimateValues,function(ev){return ev.get("Name")===est._refObjectName});return p?p.get("Value"):0},pointValueForEstimate:function(pi){return null!==pi.get("PreliminaryEstimate")?app.pointValue(pi.get("PreliminaryEstimate")):0},sumRequirementEstimates:function(reqs){return _.reduce(reqs,function(memo,r){return memo+app.pointValueForEstimate(r)},0)},columnRenderer:function(value,metaData,record,rowIdx,colIdx,store,view){console.log("v",value,"colIdx",colIdx,"name",app.columns[colIdx].text);var name=app.columns[colIdx].text,reqs=_.filter(value,function(r){return r.get("Project").Name===name});return reqs?app.sumRequirementEstimates(reqs):0},featuresLoaded:function(items){var features=items.data.items;console.log("features",features);var loadChildren=function(child,callback){child.getCollection("Children").load({fetch:!0,callback:function(records,operation,success){callback(null,records)}})};async.map(features,loadChildren,function(err,results){_.each(features,function(f,i){var requirements=results[i];console.log(f.get("Name"),requirements.length,requirements),f.set("Requirements",requirements),app.addComponentNames(requirements)}),app.grid.reconfigure(app.store,app.columns)})},addComponentNames:function(requirements){var projectNames=_.uniq(_.map(requirements,function(r){return r.get("Project").Name}));_.each(projectNames,function(name){-1==_.indexOf(app.componentNames,name)&&(app.componentNames.push(name),app.columns.push(Ext.create("Ext.grid.column.Column",{text:name,dataIndex:"Requirements",renderer:app.columnRenderer,cls:"component-color",width:75})))}),console.log("projectNames",app.componentNames)},addFeatureGrid:function(){app.store=Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Initiative",listeners:{load:app.featuresLoaded},fetch:!0}),app.grid=Ext.create("Ext.grid.Panel",{title:"Features",listeners:{afterrender:function(){app.grid.reconfigure(app.store,app.columns)}},store:app.store,columns:[app.columns],height:600,width:1200}),app.add(app.grid),app.store.load()}});

            Rally.launchApp('CustomApp', {
                name:"feature-component-summary",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */

}

.component-color {
	background-color: Gainsboro; 
}

    </style>
</head>
<body></body>
</html>
